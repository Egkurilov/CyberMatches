name: Deploy to Server

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install uvicorn fastapi psycopg[binary] python-dotenv aiohttp aiogram
    
    - name: Test Python syntax
      run: |
        echo "Testing Python syntax..."
        python -m py_compile main.py
        python -m py_compile api.py
        python -m py_compile cyber_telegram_bot_refactored.py
        echo "Python syntax check passed"
    
    - name: Test imports
      run: |
        echo "Testing imports..."
        python -c "import main; print('main.py imports OK')"
        python -c "import api; print('api.py imports OK')" 
        python -c "import cyber_telegram_bot_refactored; print('cyber_telegram_bot_refactored.py imports OK')"
        echo "Import tests passed"
    
    - name: Create deployment package
      run: |
        # Create deployment archive with explicit file list to avoid "file changed" error
        find . -type f \
          ! -path './.git/*' \
          ! -path './__pycache__/*' \
          ! -name '*.pyc' \
          ! -name '.env' \
          ! -path './logs/*.log' \
          ! -path './.github/*' \
          ! -name 'test_*.py' \
          ! -name 'migrate_*.py' \
          ! -name 'refactor_*.py' \
          ! -name 'deploy.sh' \
          ! -name 'DEPLOYMENT_SETUP.md' \
          ! -name 'cybermatches-deploy.tar.gz' \
          -print0 | tar -czf cybermatches-deploy.tar.gz --null -T -
    
    - name: Copy files to server
      uses: appleboy/scp-action@v0.1.5
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || '22' }}
        source: "cybermatches-deploy.tar.gz"
        target: "/tmp/"
        strip_components: 0
        overwrite: true
    
    - name: Prepare server for deployment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || '22' }}
        script: |
          # Clean up old deployment files
          sudo rm -rf /tmp/cybermatches-deploy.tar.gz /tmp/cybermatches-deploy 2>/dev/null || true
          
          # Stop services before deployment
          sudo systemctl stop cybermatches.service || true
          sudo systemctl stop cybermatches-api.service || true
          sudo systemctl stop cyber_telegram_bot.service || true
    
    - name: Deploy and restart services
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || '22' }}
        script: |
          
          # Backup current deployment
          cd /root
          if [ -d "cybermatches" ]; then
            sudo mv cybermatches cybermatches-backup-$(date +%Y%m%d-%H%M%S) || true
          fi
          
          # Extract new deployment
          sudo rm -rf /root/cybermatches
          sudo mkdir -p /root/cybermatches
          sudo tar -xzf /tmp/cybermatches-deploy.tar.gz -C /root/cybermatches
          sudo chown -R root:root /root/cybermatches
          
          # Create logs directory if not exists
          sudo mkdir -p /root/cybermatches/logs
          
          # Copy environment file if exists in backup
          if [ -f "/root/cybermatches-backup-*/.env" ]; then
            sudo cp /root/cybermatches-backup-*/.env /root/cybermatches/.env
          fi
          
          # Set proper permissions
          sudo chmod 600 /root/cybermatches/.env || true
          
          # Check and setup Python environment
          cd /root/cybermatches
          
          # Check if virtual environment exists, if not create it
          if [ ! -d ".venv" ]; then
            python3 -m venv .venv
          fi
          
          # Activate virtual environment and install dependencies
          source .venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install uvicorn || true
          
          # Deactivate virtual environment
          deactivate
          
          # Reload systemd and restart services
          sudo systemctl daemon-reload
          sudo systemctl enable cybermatches.service cybermatches-api.service cyber_telegram_bot.service
          sudo systemctl restart cybermatches.service cybermatches-api.service cyber_telegram_bot.service
          
          # Wait and check status with detailed logging
          sleep 5
          echo "=== Service Status Check ==="
          sudo systemctl is-active cybermatches.service && echo "✅ Parser: ACTIVE" || echo "❌ Parser: FAILED"
          sudo systemctl is-active cybermatches-api.service && echo "✅ API: ACTIVE" || echo "❌ API: FAILED"
          sudo systemctl is-active cyber_telegram_bot.service && echo "✅ Bot: ACTIVE" || echo "❌ Bot: FAILED"
          
          echo "=== Recent Logs ==="
          echo "--- Parser ---"
          sudo tail -n 5 /root/cybermatches/logs/parser.log 2>/dev/null || echo "No parser logs"
          echo "--- API ---"
          sudo tail -n 5 /root/cybermatches/logs/api.log 2>/dev/null || echo "No API logs"
          echo "--- Bot ---"
          sudo tail -n 5 /root/cybermatches/logs/bot.log 2>/dev/null || echo "No bot logs"
          
          # Clean up with error handling
          sudo rm -rf /tmp/cybermatches-deploy.tar.gz /tmp/cybermatches-deploy 2>/dev/null || true
    
    - name: Cleanup old backups
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || '22' }}
        script: |
          # Keep only last 5 backups
          cd /root
          ls -dt cybermatches-backup-* | tail -n +6 | xargs sudo rm -rf || true
