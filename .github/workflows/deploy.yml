name: Deploy to Server

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Test Python syntax
      run: |
        echo "Testing Python syntax..."
        python -m py_compile main.py
        python -m py_compile api.py
        python -m py_compile improved_parser.py
        echo "‚úÖ Python syntax check passed"
    
    - name: Create deployment package
      run: |
        # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π –∞—Ä—Ö–∏–≤ —Å –Ω—É–∂–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏
        tar -czf cybermatches-deploy.tar.gz \
          main.py \
          api.py \
          improved_parser.py \
          cyber_telegram_bot_refactored.py \
          cleanup_placeholders.py \
          update_scores.py \
          find_match_urls.py \
          requirements.txt \
          systemd_services.tar.gz \
          setup_services.sh \
          --exclude='*.pyc' \
          --exclude='.git' \
          --exclude='__pycache__' \
          --exclude='logs/*.log' \
          --exclude='.env' \
          2>/dev/null || true
    
    - name: Show package contents
      run: |
        echo "üì¶ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∞—Ä—Ö–∏–≤–∞:"
        tar -tzf cybermatches-deploy.tar.gz | head -20
        echo "..."
        echo "–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤: $(tar -tzf cybermatches-deploy.tar.gz | wc -l)"
    
    - name: Copy files to server
      uses: appleboy/scp-action@v0.1.5
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || '22' }}
        source: "cybermatches-deploy.tar.gz"
        target: "/tmp/"
        overwrite: true
    
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || '22' }}
        script: |
          echo "=== –ù–ê–ß–ò–ù–ê–ï–ú –î–ï–ü–õ–û–ô ==="
          
          # 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã
          echo "‚èπÔ∏è –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã..."
          sudo systemctl stop cybermatches.service || true
          sudo systemctl stop cybermatches-api.service || true
          sudo systemctl stop cyber_telegram_bot.service || true
          
          # 2. –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
          echo "üíæ –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é..."
          cd /root
          if [ -d "cybermatches" ]; then
            sudo mv cybermatches cybermatches-backup-$(date +%Y%m%d-%H%M%S)
            echo "‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞"
          fi
          
          # 3. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é –ø–∞–ø–∫—É –∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é
          echo "üóëÔ∏è –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –ø–∞–ø–∫—É..."
          sudo rm -rf /root/cybermatches
          sudo mkdir -p /root/cybermatches
          
          # 4. –ò–∑–≤–ª–µ—á—å –∞—Ä—Ö–∏–≤
          echo "üì¶ –ò–∑–≤–ª–µ–∫–∞–µ–º –∞—Ä—Ö–∏–≤..."
          if [ -f "/tmp/cybermatches-deploy.tar.gz" ]; then
            sudo tar -xzf /tmp/cybermatches-deploy.tar.gz -C /root/cybermatches
            echo "‚úÖ –ê—Ä—Ö–∏–≤ –∏–∑–≤–ª–µ—á–µ–Ω"
          else
            echo "‚ùå –ê—Ä—Ö–∏–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            exit 1
          fi
          
          # 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ:"
          ls -la /root/cybermatches/
          
          # 6. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞
          sudo chown -R root:root /root/cybermatches
          sudo chmod 755 /root/cybermatches
          
          # 7. –°–æ–∑–¥–∞—Ç—å .env —Ñ–∞–π–ª
          echo "üìù –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª..."
          sudo bash -c 'cat > /root/cybermatches/.env << EOF
'"${{ secrets.ENV }}"'
EOF'
          sudo chmod 600 /root/cybermatches/.env
          
          # 8. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Python –æ–∫—Ä—É–∂–µ–Ω–∏–µ
          echo "üêç –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Python –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
          cd /root/cybermatches
          
          # –°–æ–∑–¥–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω–µ—Ç
          if [ ! -d ".venv" ]; then
            python3 -m venv .venv
          fi
          
          # –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
          source .venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install fastapi uvicorn || true
          deactivate
          
          # 9. –û—á–∏—Å—Ç–∏—Ç—å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã
          echo "üßπ –û—á–∏—â–∞–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã..."
          cd /root/cybermatches
          source .venv/bin/activate
          python3 cleanup_placeholders.py || echo "‚ö†Ô∏è –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º"
          deactivate
          
          # 10. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã
          echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã..."
          sudo systemctl daemon-reload
          sudo systemctl enable cybermatches.service cybermatches-api.service cyber_telegram_bot.service
          sudo systemctl restart cybermatches.service cybermatches-api.service cyber_telegram_bot.service
          
          # 11. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
          echo "üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:"
          sleep 3
          sudo systemctl is-active cybermatches.service && echo "‚úÖ Parser: ACTIVE" || echo "‚ùå Parser: FAILED"
          sudo systemctl is-active cybermatches-api.service && echo "‚úÖ API: ACTIVE" || echo "‚ùå API: FAILED"
          sudo systemctl is-active cyber_telegram_bot.service && echo "‚úÖ Bot: ACTIVE" || echo "‚ùå Bot: FAILED"
          
          # 12. –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏
          echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
          echo "--- Parser ---"
          sudo tail -n 3 /root/cybermatches/logs/parser.log 2>/dev/null || echo "–ù–µ—Ç –ª–æ–≥–æ–≤ –ø–∞—Ä—Å–µ—Ä–∞"
          echo "--- API ---"
          sudo tail -n 3 /root/cybermatches/logs/api.log 2>/dev/null || echo "–ù–µ—Ç –ª–æ–≥–æ–≤ API"
          
          echo "=== –î–ï–ü–õ–û–ô –ó–ê–í–ï–†–®–ï–ù ==="
          
          # 13. –û—á–∏—Å—Ç–∫–∞
          sudo rm -f /tmp/cybermatches-deploy.tar.gz
    
    - name: Test deployment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || '22' }}
        script: |
          echo "=== –¢–ï–°–¢–ò–†–£–ï–ú –î–ï–ü–õ–û–ô ==="
          
          # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ñ–∞–π–ª—ã –µ—Å—Ç—å
          echo "üìÅ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã:"
          ls -la /root/cybermatches/main.py
          ls -la /root/cybermatches/api.py
          ls -la /root/cybermatches/improved_parser.py
          
          # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å–µ—Ä–≤–∏—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ä–≤–∏—Å—ã:"
          sudo systemctl status cybermatches.service --no-pager -l
          sudo systemctl status cybermatches-api.service --no-pager -l
          
          # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å API
          echo "üåê –ü—Ä–æ–≤–µ—Ä—è–µ–º API:"
          curl -s http://localhost:8050/health || echo "API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
          
          echo "‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
    
    - name: Cleanup old backups
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || '22' }}
        script: |
          # Keep only last 5 backups
          cd /root
          ls -dt cybermatches-backup-* | tail -n +6 | xargs sudo rm -rf || true
