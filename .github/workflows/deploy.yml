name: Deploy to Server

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install uvicorn fastapi psycopg[binary] python-dotenv aiohttp aiogram
    
    - name: Test Python syntax
      run: |
        echo "Testing Python syntax..."
        python -m py_compile main.py
        python -m py_compile api.py
        python -m py_compile cyber_telegram_bot_refactored.py
        echo "Python syntax check passed"
    
    - name: Test imports
      run: |
        echo "Testing imports..."
        python -c "import main; print('main.py imports OK')"
        python -c "import api; print('api.py imports OK')" 
        python -c "import cyber_telegram_bot_refactored; print('cyber_telegram_bot_refactored.py imports OK')"
        echo "Import tests passed"
    
    - name: Create deployment package
      run: |
        # Create deployment archive with unique name to avoid conflicts
        DEPLOY_TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        echo "DEPLOY_TIMESTAMP=$DEPLOY_TIMESTAMP" >> $GITHUB_ENV
        # Create deployment archive with explicit file list to avoid "file changed" error
        find . -type f \
          ! -path './.git/*' \
          ! -path './__pycache__/*' \
          ! -name '*.pyc' \
          ! -name '.env' \
          ! -path './logs/*.log' \
          ! -path './.github/*' \
          ! -name 'test_*.py' \
          ! -name 'migrate_*.py' \
          ! -name 'refactor_*.py' \
          ! -name 'deploy.sh' \
          ! -name 'DEPLOYMENT_SETUP.md' \
          ! -name "cybermatches-deploy-${DEPLOY_TIMESTAMP}.tar.gz" \
          -print0 | tar -czf "cybermatches-deploy-${DEPLOY_TIMESTAMP}.tar.gz" --null -T -
    
    - name: Copy files to server
      uses: appleboy/scp-action@v0.1.5
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || '22' }}
        source: "cybermatches-deploy-${{ env.DEPLOY_TIMESTAMP }}.tar.gz"
        target: "/tmp/"
        strip_components: 0
        overwrite: true
    
    - name: Prepare server for deployment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || '22' }}
        script: |
          # Clean up old deployment files
          sudo rm -rf /tmp/cybermatches-deploy.tar.gz /tmp/cybermatches-deploy 2>/dev/null || true
          
          # Stop services before deployment
          sudo systemctl stop cybermatches.service || true
          sudo systemctl stop cybermatches-api.service || true
          sudo systemctl stop cyber_telegram_bot.service || true
    
    - name: Deploy and restart services
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || '22' }}
        script: |
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ timestamp Ð¸Ð· Ð¸Ð¼ÐµÐ½Ð¸ Ñ„Ð°Ð¹Ð»Ð°
          TIMESTAMP_FILE=$(ls /tmp/cybermatches-deploy-*.tar.gz 2>/dev/null | head -1)
          if [ -z "$TIMESTAMP_FILE" ]; then
            echo "âŒ ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ Ð½Ð¸ Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð°Ñ€Ñ…Ð¸Ð²Ð° cybermatches-deploy-*.tar.gz"
            exit 1
          fi
          
          # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ timestamp Ð¸Ð· Ð¸Ð¼ÐµÐ½Ð¸ Ñ„Ð°Ð¹Ð»Ð°
          DEPLOY_TIMESTAMP=$(basename "$TIMESTAMP_FILE" | sed 's/cybermatches-deploy-//' | sed 's/.tar.gz//')
          echo "=== Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ timestamp: $DEPLOY_TIMESTAMP ==="
          
          echo "=== Ð”Ð•Ð‘ÐÐ“: ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ñ ==="
          echo "TIMESTAMP_FILE: $TIMESTAMP_FILE"
          echo "DEPLOY_TIMESTAMP: $DEPLOY_TIMESTAMP"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð°Ñ€Ñ…Ð¸Ð²Ð°
          echo "=== ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð°Ñ€Ñ…Ð¸Ð²Ð° ==="
          ls -la "/tmp/cybermatches-deploy-${DEPLOY_TIMESTAMP}.tar.gz" || echo "âŒ ÐÑ€Ñ…Ð¸Ð² Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
          
          # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ /tmp
          echo "=== Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ /tmp ==="
          ls -la /tmp/ | grep cybermatches || echo "âŒ ÐÐµÑ‚ cybermatches Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð² /tmp"
          
          # Backup current deployment
          cd /root
          if [ -d "cybermatches" ]; then
            echo "=== Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð±ÑÐºÐ°Ð¿Ð° ==="
            sudo mv cybermatches cybermatches-backup-$(date +%Y%m%d-%H%M%S) || true
          fi
          
          # Extract new deployment
          echo "=== Ð˜Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ñ ==="
          sudo rm -rf /root/cybermatches
          sudo mkdir -p /root/cybermatches
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð°Ñ€Ñ…Ð¸Ð² Ð¿ÐµÑ€ÐµÐ´ Ð¸Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸ÐµÐ¼
          if [ -f "/tmp/cybermatches-deploy-${DEPLOY_TIMESTAMP}.tar.gz" ]; then
            echo "âœ… ÐÑ€Ñ…Ð¸Ð² Ð½Ð°Ð¹Ð´ÐµÐ½, Ð¸Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼..."
            sudo tar -xzf "/tmp/cybermatches-deploy-${DEPLOY_TIMESTAMP}.tar.gz" -C /root/cybermatches
            echo "=== ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾ÑÐ»Ðµ Ð¸Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ñ ==="
            ls -la /root/cybermatches/ || echo "âŒ ÐŸÐ°Ð¿ÐºÐ° Ð¿ÑƒÑÑ‚Ð° Ð¿Ð¾ÑÐ»Ðµ Ð¸Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ñ!"
          else
            echo "âŒ ÐÑ€Ñ…Ð¸Ð² Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½! Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð½ÐµÐ²Ð¾Ð·Ð¼Ð¾Ð¶ÐµÐ½."
            exit 1
          fi
          
          sudo chown -R root:root /root/cybermatches
          
          # Create logs directory if not exists
          sudo mkdir -p /root/cybermatches/logs
          
          # Copy environment file if exists in backup
          if [ -f "/root/cybermatches-backup-*/.env" ]; then
            sudo cp /root/cybermatches-backup-*/.env /root/cybermatches/.env
          fi
          
          # Set proper permissions
          sudo chmod 600 /root/cybermatches/.env || true
          
          # Check and setup Python environment
          cd /root/cybermatches
          
          # Check if virtual environment exists, if not create it
          if [ ! -d ".venv" ]; then
            python3 -m venv .venv
          fi
          
          # Activate virtual environment and install dependencies
          source .venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install fastapi uvicorn[standard] || true
          
          # Deactivate virtual environment
          deactivate
          
          # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð‘Ð” Ð¾Ñ‚ Ð¿Ð»ÐµÐ¹ÑÑ…Ð¾Ð»Ð´ÐµÑ€Ð¾Ð²
          echo "ðŸ§¹ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð‘Ð” Ð¾Ñ‚ Ð¿Ð»ÐµÐ¹ÑÑ…Ð¾Ð»Ð´ÐµÑ€Ð¾Ð² ÐºÐ¾Ð¼Ð°Ð½Ð´..."
          cd /root/cybermatches
          source .venv/bin/activate
          python3 cleanup_placeholders.py || echo "âš ï¸ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ð»Ð°ÑÑŒ Ñ Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸ÐµÐ¼"
          deactivate
          
          # Reload systemd and restart services
          sudo systemctl daemon-reload
          sudo systemctl enable cybermatches.service cybermatches-api.service cyber_telegram_bot.service
          sudo systemctl restart cybermatches.service cybermatches-api.service cyber_telegram_bot.service
          
          # Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ
          echo "=== Ð¤Ð˜ÐÐÐ›Ð¬ÐÐÐ¯ ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ ==="
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð°Ð±ÑÐ¾Ð»ÑŽÑ‚Ð½Ñ‹Ð¹ Ð¿ÑƒÑ‚ÑŒ
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð°Ð±ÑÐ¾Ð»ÑŽÑ‚Ð½Ñ‹Ð¹ Ð¿ÑƒÑ‚ÑŒ /root/cybermatches:"
          ls -la /root/cybermatches/ 2>/dev/null || echo "âŒ /root/cybermatches Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
          echo "Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ: $(pwd)"
          echo "Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸:"
          ls -la 2>/dev/null || echo "âŒ Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ Ð¿ÑƒÑÑ‚Ð°"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð³Ð´Ðµ Ð¼Ñ‹ Ð½Ð°Ñ…Ð¾Ð´Ð¸Ð¼ÑÑ
          echo "ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ Ð¿ÑƒÑ‚ÑŒ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸: $(pwd)"
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÑÐºÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ:"
          ls -la ../ 2>/dev/null || echo "âŒ Ð Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÑÐºÐ°Ñ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ Ð¿ÑƒÑÑ‚Ð°"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð²ÑÐµ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ Ð¼ÐµÑÑ‚Ð°
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ /home/:"
          ls -la /home/ 2>/dev/null || echo "âŒ /home/ Ð¿ÑƒÑÑ‚Ð°"
          
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ /tmp/:"
          ls -la /tmp/ 2>/dev/null | grep -E "(cybermatches|main\.py)" || echo "âŒ Ð’ /tmp/ Ð½ÐµÑ‚ cybermatches Ñ„Ð°Ð¹Ð»Ð¾Ð²"
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð» Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÐµÐ¹ Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ðµ Ð² Ð»ÑŽÐ±Ð¾Ð¼ ÑÐ»ÑƒÑ‡Ð°Ðµ
          mkdir -p /root/cybermatches
          echo "Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½: $(date)" > /root/cybermatches/DEPLOY_INFO.txt
          echo "Timestamp: $DEPLOY_TIMESTAMP" >> /root/cybermatches/DEPLOY_INFO.txt
          echo "ÐŸÑƒÑ‚ÑŒ Ð¸Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ñ: /root/cybermatches" >> /root/cybermatches/DEPLOY_INFO.txt
          echo "Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ: $(pwd)" >> /root/cybermatches/DEPLOY_INFO.txt
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾ÑÐ»Ðµ Ð¸Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ñ:" >> /root/cybermatches/DEPLOY_INFO.txt
          ls -la /root/cybermatches/ 2>/dev/null >> /root/cybermatches/DEPLOY_INFO.txt || echo "ÐŸÐ°Ð¿ÐºÐ° Ð¿ÑƒÑÑ‚Ð°" >> /root/cybermatches/DEPLOY_INFO.txt
          
          # Wait and check status with detailed logging
          sleep 5
          echo "=== Service Status Check ==="
          sudo systemctl is-active cybermatches.service && echo "âœ… Parser: ACTIVE" || echo "âŒ Parser: FAILED"
          sudo systemctl is-active cybermatches-api.service && echo "âœ… API: ACTIVE" || echo "âŒ API: FAILED"
          sudo systemctl is-active cyber_telegram_bot.service && echo "âœ… Bot: ACTIVE" || echo "âŒ Bot: FAILED"
          
          echo "=== Recent Logs ==="
          echo "--- Parser ---"
          sudo tail -n 5 /root/cybermatches/logs/parser.log 2>/dev/null || echo "No parser logs"
          echo "--- API ---"
          sudo tail -n 5 /root/cybermatches/logs/api.log 2>/dev/null || echo "No API logs"
          echo "--- Bot ---"
          sudo tail -n 5 /root/cybermatches/logs/bot.log 2>/dev/null || echo "No bot logs"
          
          # Clean up with error handling
          sudo rm -rf /tmp/cybermatches-deploy.tar.gz /tmp/cybermatches-deploy 2>/dev/null || true
    
    - name: Cleanup old backups
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || '22' }}
        script: |
          # Keep only last 5 backups
          cd /root
          ls -dt cybermatches-backup-* | tail -n +6 | xargs sudo rm -rf || true
