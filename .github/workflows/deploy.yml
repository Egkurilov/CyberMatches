name: Deploy to Server

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Test Python syntax
      run: |
        echo "Testing Python syntax..."
        python -m py_compile main.py
        python -m py_compile api.py
        python -m py_compile improved_parser.py
        echo "‚úÖ Python syntax check passed"
    
    - name: Create deployment package
      run: |
        tar -czf cybermatches-deploy.tar.gz \
          main.py \
          api.py \
          improved_parser.py \
          cyber_telegram_bot_refactored.py \
          cleanup_placeholders.py \
          update_scores.py \
          find_match_urls.py \
          requirements.txt \
          systemd_services.tar.gz \
          setup_services.sh
    
    - name: Show package contents
      run: |
        echo "üì¶ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∞—Ä—Ö–∏–≤–∞:"
        tar -tzf cybermatches-deploy.tar.gz
        echo "–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤: $(tar -tzf cybermatches-deploy.tar.gz | wc -l)"
    
    - name: Copy files to server
      uses: appleboy/scp-action@v0.1.5
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || '22' }}
        source: "cybermatches-deploy.tar.gz"
        target: "/tmp/"
        overwrite: true
    
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || '22' }}
        script: |
          set -e
          echo "=== –ù–ê–ß–ò–ù–ê–ï–ú –î–ï–ü–õ–û–ô ==="
          
          # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã
          sudo systemctl stop cybermatches.service || true
          sudo systemctl stop cybermatches-api.service || true
          sudo systemctl stop cyber_telegram_bot.service || true
          
          # –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
          cd /root
          if [ -d "cybermatches" ]; then
            sudo mv cybermatches cybermatches-backup-$(date +%Y%m%d-%H%M%S)
          fi
          
          # –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é –ø–∞–ø–∫—É –∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é
          sudo rm -rf /root/cybermatches
          sudo mkdir -p /root/cybermatches
          
          # –ò–∑–≤–ª–µ—á—å –∞—Ä—Ö–∏–≤
          sudo tar -xzf /tmp/cybermatches-deploy.tar.gz -C /root/cybermatches
          
          # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞
          sudo chown -R root:root /root/cybermatches
          sudo chmod 755 /root/cybermatches
          
          # –°–æ–∑–¥–∞—Ç—å .env —Ñ–∞–π–ª
          echo "${{ secrets.ENV }}" | sudo tee /root/cybermatches/.env > /dev/null
          sudo chmod 600 /root/cybermatches/.env
          
          # –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Python –æ–∫—Ä—É–∂–µ–Ω–∏–µ
          cd /root/cybermatches
          python3 -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install fastapi uvicorn
          deactivate
          
          # –û—á–∏—Å—Ç–∏—Ç—å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã
          source .venv/bin/activate
          python3 cleanup_placeholders.py || true
          deactivate
          
          # –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã
          sudo systemctl daemon-reload
          sudo systemctl enable cybermatches.service cybermatches-api.service cyber_telegram_bot.service
          sudo systemctl restart cybermatches.service cybermatches-api.service cyber_telegram_bot.service
          
          # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
          sleep 3
          echo "–°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:"
          sudo systemctl is-active cybermatches.service && echo "‚úÖ Parser: ACTIVE" || echo "‚ùå Parser: FAILED"
          sudo systemctl is-active cybermatches-api.service && echo "‚úÖ API: ACTIVE" || echo "‚ùå API: FAILED"
          sudo systemctl is-active cyber_telegram_bot.service && echo "‚úÖ Bot: ACTIVE" || echo "‚ùå Bot: FAILED"
          
          echo "=== –î–ï–ü–õ–û–ô –ó–ê–í–ï–†–®–ï–ù ==="
    
    - name: Test deployment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || '22' }}
        script: |
          echo "=== –¢–ï–°–¢–ò–†–£–ï–ú –î–ï–ü–õ–û–ô ==="
          ls -la /root/cybermatches/main.py /root/cybermatches/api.py /root/cybermatches/improved_parser.py
          sudo systemctl status cybermatches.service --no-pager -l
          sudo systemctl status cybermatches-api.service --no-pager -l
          curl -s http://localhost:8050/health || echo "API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
          echo "‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
    
    - name: Cleanup old backups
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || '22' }}
        script: |
          cd /root
          ls -dt cybermatches-backup-* | tail -n +6 | xargs sudo rm -rf || true
