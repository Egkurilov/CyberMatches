#!/usr/bin/env python3
"""
–§–∏–Ω–∞–ª—å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞ - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –Ω–∞ —É—Ä–æ–≤–Ω–µ –≤—Å–µ–π —Ñ—É–Ω–∫—Ü–∏–∏
"""

import psycopg
import os
from dotenv import load_dotenv

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

DB_HOST = os.getenv("DB_HOST", "localhost")
DB_PORT = int(os.getenv("DB_PORT", "5432"))
DB_NAME = os.getenv("DB_NAME", "postgres")
DB_USER = os.getenv("DB_USER", "postgres")
DB_PASSWORD = os.getenv("DB_PASSWORD", "")

def fix_duplicate_issues():
    """–£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É"""
    print("üîß –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ–±–ª–µ–º—É —Å –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏...")
    
    try:
        with psycopg.connect(
            host=DB_HOST,
            port=DB_PORT,
            dbname=DB_NAME,
            user=DB_USER,
            password=DB_PASSWORD,
        ) as conn:
            with conn.cursor() as cur:
                # 1. –ù–∞—Ö–æ–¥–∏–º –∏ —É–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
                print("1. –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...")
                
                # –ù–∞—Ö–æ–¥–∏–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –ø–æ–ª–µ–π
                cur.execute("""
                    SELECT match_time_msk, team1, team2, tournament, bo, COUNT(*) as cnt
                    FROM dota_matches
                    WHERE match_time_msk IS NOT NULL 
                      AND team1 IS NOT NULL 
                      AND team2 IS NOT NULL
                    GROUP BY match_time_msk, team1, team2, tournament, bo
                    HAVING COUNT(*) > 1
                    ORDER BY cnt DESC;
                """)
                
                duplicates = cur.fetchall()
                print(f"–ù–∞–π–¥–µ–Ω–æ –≥—Ä—É–ø–ø —Å –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏: {len(duplicates)}")
                
                if duplicates:
                    # –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É –∑–∞–ø–∏—Å—å —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º ID
                    cur.execute("""
                        DELETE FROM dota_matches a
                        USING dota_matches b
                        WHERE a.id < b.id
                          AND a.match_time_msk = b.match_time_msk
                          AND a.team1 = b.team1
                          AND a.team2 = b.team2
                          AND a.tournament = b.tournament
                          AND a.bo = b.bo;
                    """)
                    
                    deleted_count = cur.rowcount
                    print(f"–£–¥–∞–ª–µ–Ω–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤: {deleted_count}")
                
                # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                cur.execute("SELECT COUNT(*) FROM dota_matches;")
                total_matches = cur.fetchone()[0]
                print(f"–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—Ç—á–µ–π –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏: {total_matches}")
                
                conn.commit()
                print("‚úÖ –û—á–∏—Å—Ç–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
                
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤: {e}")
        return False
    
    return True

if __name__ == "__main__":
    fix_duplicate_issues()
